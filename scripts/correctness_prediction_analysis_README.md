# æ­£ç¡®æ€§é¢„æµ‹åˆ†æè„šæœ¬

## æ¦‚è¿°

`correctness_prediction_analysis.py` æ˜¯ä¸€ä¸ªç”¨äºåˆ†æ32Bå¤§æ¨¡å‹è¾…åŠ©å¯¹7Bå°æ¨¡å‹æ€§èƒ½å½±å“çš„æœºå™¨å­¦ä¹ å·¥å…·ã€‚è¯¥è„šæœ¬èƒ½å¤Ÿï¼š

1. **è‡ªåŠ¨è¯„ä¼°ç­”æ¡ˆæ­£ç¡®æ€§**ï¼šé›†æˆ `eval_acc_lm_eval.py` è¿›è¡Œè‡ªåŠ¨åŒ–è¯„ä¼°
2. **è¯†åˆ«è¾…åŠ©æ•ˆæœçš„4ç§æƒ…å†µ**ï¼š
   - âœ… å¯¹â†’å¯¹ï¼šåŸæœ¬æ­£ç¡®ï¼Œè¾…åŠ©åä»æ­£ç¡®ï¼ˆä¿æŒè‰¯å¥½ï¼‰
   - âŒ **å¯¹â†’é”™ï¼šåŸæœ¬æ­£ç¡®ï¼Œè¾…åŠ©åå˜é”™è¯¯ï¼ˆéœ€è¦é¿å…ï¼‰**
   - ğŸ”„ é”™â†’é”™ï¼šåŸæœ¬é”™è¯¯ï¼Œè¾…åŠ©åä»é”™è¯¯ï¼ˆæ— æ”¹å–„ï¼‰
   - ğŸ¯ é”™â†’å¯¹ï¼šåŸæœ¬é”™è¯¯ï¼Œè¾…åŠ©åå˜æ­£ç¡®ï¼ˆæ˜¾è‘—æ”¹å–„ï¼‰
3. **è®­ç»ƒé¢„æµ‹æ¨¡å‹**ï¼šä¸“é—¨è¯†åˆ«å¯èƒ½å¯¼è‡´"å¯¹â†’é”™"çš„æœ‰å®³è¾…åŠ©
4. **é€‰æ‹©æ€§åº”ç”¨è¾…åŠ©**ï¼šé€šè¿‡é¢„æµ‹è¿‡æ»¤æ‰æœ‰å®³çš„è¾…åŠ©ï¼Œå®ç°æœ€ä¼˜æ€§èƒ½

## æ ¸å¿ƒæ€æƒ³

### é—®é¢˜èƒŒæ™¯
åœ¨Ensemble-Hubçš„improveæ¨¡å¼ä¸­ï¼š
- å‰1000ä¸ªtokenç”±32Bå¤§æ¨¡å‹ç”Ÿæˆï¼ˆé«˜è´¨é‡è¾…åŠ©ï¼‰
- åç»­tokenç”±7Bå°æ¨¡å‹ç»§ç»­ç”Ÿæˆ
- ä½†æœ‰æ—¶32Bçš„è¾…åŠ©åè€Œä¼šè¯¯å¯¼7Bæ¨¡å‹ï¼Œå¯¼è‡´åŸæœ¬æ­£ç¡®çš„ç­”æ¡ˆå˜é”™

### è§£å†³æ–¹æ¡ˆ
é€šè¿‡åˆ†æ32Bè¾…åŠ©tokençš„ç»Ÿè®¡ç‰¹å¾ï¼ˆPPLã€ç†µç­‰ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥é¢„æµ‹è¿™ç§è¾…åŠ©æ˜¯å¦ä¼šäº§ç”Ÿè´Ÿé¢å½±å“ï¼Œä»è€Œé€‰æ‹©æ€§åœ°åº”ç”¨è¾…åŠ©ï¼š

- **ä½PPLï¼ˆå›°æƒ‘åº¦ï¼‰**ï¼šæ¨¡å‹å¯¹æ–‡æœ¬æ›´ç¡®å®šï¼Œé€šå¸¸è¡¨ç¤ºç­”æ¡ˆæ›´æµç•…
- **é€‚ä¸­Entropyï¼ˆç†µï¼‰**ï¼šæ—¢ä¸è¿‡äºç¡®å®šä¹Ÿä¸è¿‡äºä¸ç¡®å®š
- **è¶‹åŠ¿ç‰¹å¾**ï¼štokenåºåˆ—ä¸­PPL/ç†µçš„å˜åŒ–æ¨¡å¼

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```bash
# ä½¿ç”¨é»˜è®¤çš„base.jsonlå’Œenhanced1000.jsonlè¿›è¡Œåˆ†æ
python scripts/correctness_prediction_analysis.py

# æŒ‡å®šç‰¹å®šçš„æ–‡ä»¶
python scripts/correctness_prediction_analysis.py \
    --base saves/base.jsonl \
    --enhanced saves/enhanced1000.jsonl \
    --output-dir saves/impact_analysis

# è°ƒæ•´åˆ†æå‚æ•°
python scripts/correctness_prediction_analysis.py \
    --n-tokens 1000 \          # åˆ†æå‰1000ä¸ªè¾…åŠ©token
    --threshold 0.3 \          # æ›´ä¸¥æ ¼çš„è¿‡æ»¤é˜ˆå€¼
    --model deepseek-ai/DeepSeek-R1-Distill-Qwen-7B
```

### å‚æ•°è¯´æ˜

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--base` | `saves/base.jsonl` | 7Bæ¨¡å‹å•ç‹¬æ¨ç†çš„ç»“æœæ–‡ä»¶ |
| `--enhanced` | `saves/enhanced1000.jsonl` | 32B+7Bæ··åˆæ¨ç†çš„ç»“æœæ–‡ä»¶ |
| `--output-dir` | `saves/assistance_impact_output` | è¾“å‡ºç›®å½• |
| `--model` | `deepseek-ai/DeepSeek-R1-Distill-Qwen-7B` | ç”¨äºç‰¹å¾æå–çš„æ¨¡å‹ |
| `--n-tokens` | `1000` | åˆ†æçš„è¾…åŠ©tokenæ•°é‡ |
| `--threshold` | `0.5` | è¿‡æ»¤æœ‰å®³è¾…åŠ©çš„æ¦‚ç‡é˜ˆå€¼ |

## å·¥ä½œæµç¨‹

### 1. è‡ªåŠ¨è¯„ä¼°
- æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¯„ä¼°ç»“æœæ–‡ä»¶
- å¦‚ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨è°ƒç”¨ `eval_acc_lm_eval.py` è¿›è¡Œè¯„ä¼°
- ä¿å­˜è¯„ä¼°ç»“æœé¿å…é‡å¤è®¡ç®—

### 2. æ•°æ®åŒ¹é…
- æŒ‰é—®é¢˜æ–‡æœ¬åŒ¹é…baseå’Œenhancedç»“æœ
- æ·»åŠ æ­£ç¡®æ€§æ ‡ç­¾åˆ°æ¯ä¸ªæ ·æœ¬

### 3. å½±å“åˆ†ç±»
- å°†æ¯ä¸ªæ ·æœ¬åˆ†ç±»åˆ°4ç§å½±å“ç±»åˆ«
- ç»Ÿè®¡å„ç±»åˆ«çš„æ•°é‡å’Œæ¯”ä¾‹

### 4. ç‰¹å¾æå–
- ä»32Bè¾…åŠ©tokenä¸­æå–16ä¸ªç‰¹å¾
- åŒ…æ‹¬PPLã€ç†µçš„ç»Ÿè®¡é‡å’Œè¶‹åŠ¿ç‰¹å¾

### 5. æ¨¡å‹è®­ç»ƒ
- è®­ç»ƒé€»è¾‘å›å½’å’Œéšæœºæ£®æ—æ¨¡å‹
- ä¸“é—¨é¢„æµ‹"å¯¹â†’é”™"çš„æœ‰å®³æƒ…å†µ

### 6. æ€§èƒ½è®¡ç®—
- è®¡ç®—baseã€enhancedã€filteredä¸‰ç§ç­–ç•¥çš„ç²¾åº¦
- åˆ†æè¿‡æ»¤æ•ˆæœå’Œæ”¹è¿›å¹…åº¦

## ç‰¹å¾å·¥ç¨‹

è„šæœ¬ä»å‰Nä¸ªè¾…åŠ©tokenï¼ˆé»˜è®¤1000ï¼‰ä¸­æå–16ä¸ªç‰¹å¾ï¼š

### PPLç‰¹å¾ï¼ˆ7ä¸ªï¼‰
- `assistance_ppl_mean`: å¹³å‡å›°æƒ‘åº¦
- `assistance_ppl_std/median/max/min`: æ ‡å‡†å·®ã€ä¸­ä½æ•°ã€æœ€å€¼
- `assistance_ppl_q25/q75`: 25%/75%åˆ†ä½æ•°

### Entropyç‰¹å¾ï¼ˆ7ä¸ªï¼‰
- `assistance_entropy_mean`: å¹³å‡ç†µ
- `assistance_entropy_std/median/max/min`: æ ‡å‡†å·®ã€ä¸­ä½æ•°ã€æœ€å€¼
- `assistance_entropy_q25/q75`: 25%/75%åˆ†ä½æ•°

### è¶‹åŠ¿ç‰¹å¾ï¼ˆ2ä¸ªï¼‰
- `assistance_ppl_trend`: å‰20 vs å20ä¸ªtokençš„PPLå˜åŒ–
- `assistance_entropy_trend`: å‰20 vs å20ä¸ªtokençš„Entropyå˜åŒ–

### å…¶ä»–ç‰¹å¾ï¼ˆ1ä¸ªï¼‰
- `assistance_token_count`: å®é™…åˆ†æçš„tokenæ•°é‡

## è¾“å‡ºæ–‡ä»¶

### 1. å¯è§†åŒ–å›¾è¡¨
- `impact_overview.png`ï¼šå½±å“åˆ†å¸ƒé¥¼å›¾å’Œç²¾åº¦å¯¹æ¯”
- `harm_predictors.png`ï¼šæœ‰å®³è¾…åŠ©çš„ç‰¹å¾é‡è¦æ€§åˆ†æ
- `harm_analysis.png`ï¼šPPL/ç†µåˆ†å¸ƒå’Œé¢„æµ‹æ€§èƒ½æ›²çº¿

### 2. æ•°æ®æ–‡ä»¶
- `correct_to_correct_samples.jsonl`ï¼šä¿æŒæ­£ç¡®çš„æ ·æœ¬
- `correct_to_incorrect_samples.jsonl`ï¼š**å˜å·®çš„æ ·æœ¬ï¼ˆé‡ç‚¹å…³æ³¨ï¼‰**
- `incorrect_to_correct_samples.jsonl`ï¼šæ”¹å–„çš„æ ·æœ¬
- `incorrect_to_incorrect_samples.jsonl`ï¼šæ— å˜åŒ–çš„æ ·æœ¬
- `analysis_summary.json`ï¼šå®Œæ•´åˆ†æç»“æœæ‘˜è¦

### 3. è‡ªåŠ¨ç”Ÿæˆçš„è¯„ä¼°æ–‡ä»¶
- `base_eval_results.jsonl`ï¼šbaseç»“æœçš„æ­£ç¡®æ€§è¯„ä¼°
- `enhanced1000_eval_results.jsonl`ï¼šenhancedç»“æœçš„æ­£ç¡®æ€§è¯„ä¼°

## ç»“æœè§£é‡Š

### å…¸å‹è¾“å‡ºç¤ºä¾‹

```
=== Impact Analysis ===
correct_to_correct: 320 (64.0%)
correct_to_incorrect: 40 (8.0%)     # è¿™æ˜¯æˆ‘ä»¬è¦é¿å…çš„
incorrect_to_correct: 65 (13.0%)    # è¿™æ˜¯æˆ‘ä»¬æƒ³è¦çš„
incorrect_to_incorrect: 75 (15.0%)

=== Training Harm Predictor ===
Logistic Regression F1: 0.815 (+/- 0.038)
Random Forest F1: 0.847 (+/- 0.042)

=== Accuracy Analysis ===
Base (7B only) accuracy: 0.720 (360/500)
Enhanced (always use 32B) accuracy: 0.770 (385/500)
Filtered (selective 32B) accuracy: 0.825 (412/500)

Filtering Statistics:
  Kept assistance: 380 (76.0%)
  Rejected assistance: 120 (24.0%)
  Avoided harmful cases: 35
  Missed helpful cases: 8

=== RECOMMENDATION ===
Using selective 32B assistance improves accuracy by 10.5%
From 72.0% â†’ 82.5%
```

### å…³é”®æŒ‡æ ‡è¯´æ˜

1. **å½±å“åˆ†å¸ƒ**ï¼š
   - é«˜æ¯”ä¾‹çš„"å¯¹â†’å¯¹"è¯´æ˜è¾…åŠ©æ€»ä½“æ˜¯æœ‰ç›Šçš„
   - å…³æ³¨"å¯¹â†’é”™"çš„æ¯”ä¾‹ï¼Œè¿™æ˜¯éœ€è¦è¿‡æ»¤çš„é‡ç‚¹

2. **é¢„æµ‹å™¨æ€§èƒ½**ï¼š
   - F1åˆ†æ•°è¡¡é‡è¯†åˆ«æœ‰å®³è¾…åŠ©çš„èƒ½åŠ›
   - 0.8+çš„F1åˆ†æ•°è¡¨ç¤ºè‰¯å¥½çš„é¢„æµ‹æ€§èƒ½

3. **ç²¾åº¦æå‡**ï¼š
   - **Base**: ä»…ä½¿ç”¨7Bæ¨¡å‹çš„åŸºå‡†ç²¾åº¦
   - **Enhanced**: æ€»æ˜¯ä½¿ç”¨32Bè¾…åŠ©çš„ç²¾åº¦
   - **Filtered**: é€‰æ‹©æ€§ä½¿ç”¨32Bè¾…åŠ©çš„æœ€ç»ˆç²¾åº¦

4. **è¿‡æ»¤ç»Ÿè®¡**ï¼š
   - **Avoided harmful cases**: æˆåŠŸé¿å…çš„"å¯¹â†’é”™"æƒ…å†µ
   - **Missed helpful cases**: è¯¯è¿‡æ»¤çš„"é”™â†’å¯¹"æƒ…å†µ
   - ç†æƒ³æƒ…å†µæ˜¯å‰è€…å¤šã€åè€…å°‘

## åº”ç”¨åœºæ™¯

### 1. æ¨ç†æ—¶é€‰æ‹©æ€§è¾…åŠ©
```python
# ä¼ªä»£ç ç¤ºä¾‹
assistance_features = extract_features(assistance_tokens)
if harm_predictor.predict_proba(assistance_features) < threshold:
    use_32b_assistance()
else:
    use_7b_only()
```

### 2. è®­ç»ƒæ•°æ®ç­›é€‰
- è¿‡æ»¤æ‰å¯èƒ½äº§ç”Ÿè´Ÿé¢å½±å“çš„è®­ç»ƒæ ·æœ¬
- ä¸“æ³¨äºçœŸæ­£æœ‰å¸®åŠ©çš„è¾…åŠ©æ¡ˆä¾‹

### 3. æ¨¡å‹æ”¹è¿›æ–¹å‘
- åˆ†æ"å¯¹â†’é”™"æ¡ˆä¾‹çš„å…±åŒç‰¹å¾
- é’ˆå¯¹æ€§åœ°æ”¹è¿›32Bæ¨¡å‹çš„è¾…åŠ©ç­–ç•¥

## æœ€ä½³å®è·µ

### 1. é˜ˆå€¼è°ƒä¼˜
- **è¾ƒä½é˜ˆå€¼ï¼ˆ0.3ï¼‰**ï¼šæ›´æ¿€è¿›åœ°è¿‡æ»¤ï¼Œç²¾åº¦ä¼˜å…ˆ
- **è¾ƒé«˜é˜ˆå€¼ï¼ˆ0.7ï¼‰**ï¼šæ›´å¤šä¿ç•™è¾…åŠ©ï¼Œå¬å›ä¼˜å…ˆ
- **å»ºè®®0.5**ï¼šå¹³è¡¡ç²¾åº¦å’Œå¬å›

### 2. æ ·æœ¬è¦æ±‚
- ç¡®ä¿æœ‰è¶³å¤Ÿçš„"å¯¹â†’é”™"æ ·æœ¬è®­ç»ƒé¢„æµ‹å™¨
- è‡³å°‘éœ€è¦å‡ åä¸ªæœ‰å®³æ¡ˆä¾‹æ‰èƒ½æœ‰æ•ˆè®­ç»ƒ

### 3. å®šæœŸæ›´æ–°
- éšç€æ¨¡å‹æ›´æ–°ï¼Œé‡æ–°åˆ†æè¾…åŠ©å½±å“
- è°ƒæ•´é¢„æµ‹å™¨å’Œé˜ˆå€¼å‚æ•°

## æŠ€æœ¯ç»†èŠ‚

### è®¡ç®—å¤æ‚åº¦
- ç‰¹å¾æå–ï¼šO(n Ã— m)ï¼Œnä¸ºæ ·æœ¬æ•°ï¼Œmä¸ºtokenæ•°
- é¢„æµ‹å™¨è®­ç»ƒï¼šO(n Ã— kÂ²)ï¼Œkä¸ºç‰¹å¾æ•°
- æ¨ç†æ—¶é¢„æµ‹ï¼šO(1)ï¼Œå®æ—¶å¯ç”¨

### å†…å­˜éœ€æ±‚
- éœ€è¦åŠ è½½7Bæ¨¡å‹è¿›è¡Œç‰¹å¾æå–
- å»ºè®®è‡³å°‘16GB GPUå†…å­˜

### ä¾èµ–é¡¹
- transformersï¼ˆæ¨¡å‹åŠ è½½ï¼‰
- scikit-learnï¼ˆæœºå™¨å­¦ä¹ ï¼‰
- matplotlib/seabornï¼ˆå¯è§†åŒ–ï¼‰
- jsonlinesï¼ˆæ•°æ®å¤„ç†ï¼‰
- subprocessï¼ˆè‡ªåŠ¨è¯„ä¼°ï¼‰

## ä¸å…¶ä»–è„šæœ¬çš„å…³ç³»

- **`eval_acc_lm_eval.py`**ï¼šè¢«è‡ªåŠ¨è°ƒç”¨è¿›è¡Œç­”æ¡ˆæ­£ç¡®æ€§è¯„ä¼°
- **`complete_token_analysis.py`**ï¼šå…±äº«TokenAnalyzerç±»å’Œéƒ¨åˆ†å·¥å…·å‡½æ•°
- **`grader.py`**ï¼šç”¨äºæ‰‹åŠ¨è¯„ä¼°ç­”æ¡ˆæ­£ç¡®æ€§ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰

## å±€é™æ€§å’Œæ³¨æ„äº‹é¡¹

### 1. æ•°æ®ä¾èµ–
- **é¢†åŸŸç‰¹å¼‚æ€§**ï¼šåœ¨æ•°å­¦é¢˜ä¸Šè®­ç»ƒï¼Œå¯èƒ½ä¸é€‚ç”¨å…¶ä»–é¢†åŸŸ
- **æ¨¡å‹ç‰¹å¼‚æ€§**ï¼šåŸºäºç‰¹å®š7Bæ¨¡å‹çš„ç‰¹å¾
- **Tokené™åˆ¶**ï¼šåªåˆ†æå‰Nä¸ªtokenï¼Œé•¿ç­”æ¡ˆçš„åç»­éƒ¨åˆ†ä¸è¢«è€ƒè™‘

### 2. å› æœå…³ç³»
- **ç›¸å…³vså› æœ**ï¼šä½PPLå’Œæ­£ç¡®æ€§å¯èƒ½éƒ½ç”±ç¬¬ä¸‰å› ç´ å¯¼è‡´
- **æ¨¡å‹åè§**ï¼š7Bæ¨¡å‹çš„åè§å¯èƒ½å½±å“é¢„æµ‹

### 3. æ€§èƒ½ä¸Šé™
- **å¤©èŠ±æ¿æ•ˆåº”**ï¼šåŸºäºç»Ÿè®¡ç‰¹å¾çš„é¢„æµ‹æœ‰å¤©ç„¶ä¸Šé™
- **å¤æ‚æ¨ç†**ï¼šæ— æ³•æ•æ‰æ·±å±‚é€»è¾‘é”™è¯¯

### 4. é˜ˆå€¼è°ƒæ•´
- **æ•°æ®é›†å·®å¼‚**ï¼šä¸åŒæ•°æ®é›†çš„æœ€ä¼˜é˜ˆå€¼å¯èƒ½ä¸åŒ
- **éœ€é‡æ–°æ ¡å‡†**ï¼šåœ¨æ–°æ•°æ®ä¸Šä½¿ç”¨å‰åº”é‡æ–°è¯„ä¼°